{
  "version": 3,
  "sources": ["../web/fileview.ts"],
  "sourcesContent": ["/**\n * Copyright 2011-2013 Nelson Elhage\n * SPDX-License-Identifier: BSD-2-Clause\n */\n\nimport jQuery from \"jquery\";\nimport \"./codesearch.css\";\nimport \"./fileview.css\";\n\nvar KeyCodes = {\n    ESCAPE: 27,\n    ENTER: 13,\n    SLASH_OR_QUESTION_MARK: 191,\n};\n\nfunction getSelectedText() {\n    return window.getSelection ? window.getSelection()?.toString() : null;\n}\n\nfunction scrollToRange(range, elementContainer) {\n    // - If we have a single line, scroll the viewport so that the element is\n    // at 1/3 of the viewport.\n    // - If we have a range, try and center the range in the viewport\n    // - If the range is to high to fit in the viewport, fallback to the single\n    //   element scenario for the first line\n    var viewport = jQuery(window);\n    var viewportHeight = viewport.height();\n\n    var scrollOffset = Math.floor(viewport.height() / 3.0);\n\n    var firstLineElement = elementContainer.find(\"#L\" + range.start);\n    if (!firstLineElement.length) {\n        // We were given a scroll offset to a line number that doesn't exist in the page, bail\n        return;\n    }\n    if (range.start != range.end) {\n        // We have a range, try and center the entire range. If it's to high\n        // for the viewport, fallback to revealing the first element.\n        var lastLineElement = elementContainer.find(\"#L\" + range.end);\n        var rangeHeight =\n            lastLineElement.offset().top + lastLineElement.height() - firstLineElement.offset().top;\n        if (rangeHeight <= viewportHeight) {\n            // Range fits in viewport, center it\n            scrollOffset = 0.5 * (viewportHeight - rangeHeight);\n        } else {\n            scrollOffset = firstLineElement.height() / 2; // Stick to (almost) the top of the viewport\n        }\n    }\n\n    viewport.scrollTop(firstLineElement.offset().top - scrollOffset);\n}\n\nfunction setHash(hash) {\n    if (history.replaceState) {\n        history.replaceState(null, \"\", hash);\n    } else {\n        location.hash = hash;\n    }\n}\n\nfunction parseHashForLineRange(hashString) {\n    var parseMatch = hashString.match(/#L(\\d+)(?:-L?(\\d+))?/);\n\n    if (parseMatch && parseMatch.length === 3) {\n        // We have a match on the regex expression\n        var startLine = parseInt(parseMatch[1], 10);\n        var endLine = parseInt(parseMatch[2], 10);\n        if (isNaN(endLine) || endLine < startLine) {\n            endLine = startLine;\n        }\n        return {\n            start: startLine,\n            end: endLine,\n        };\n    }\n\n    return null;\n}\n\nfunction addHighlightClassesForRange(range, root) {\n    var idSelectors = [];\n    for (var lineNumber = range.start; lineNumber <= range.end; lineNumber++) {\n        idSelectors.push(\"#L\" + lineNumber);\n    }\n    root.find(idSelectors.join(\",\")).addClass(\"highlighted\");\n}\n\nfunction expandRangeToElement(element) {\n    var range = parseHashForLineRange(document.location.hash);\n    if (range) {\n        var elementLine = parseInt(element.attr(\"id\").replace(\"L\", \"\"), 10);\n        if (elementLine < range.start) {\n            range.end = range.start;\n            range.start = elementLine;\n        } else {\n            range.end = elementLine;\n        }\n        setHash(\"#L\" + range.start + \"-\" + range.end);\n    }\n}\n\nfunction init(initData) {\n    var root = jQuery(\".file-content\");\n    var lineNumberContainer = root.find(\".line-numbers\");\n    var helpScreen = jQuery(\".help-screen\");\n\n    function doSearch(event, query, newTab) {\n        var url;\n        if (query !== undefined) {\n            url =\n                \"/search?q=\" +\n                encodeURIComponent(query) +\n                \"&repo=\" +\n                encodeURIComponent(initData.repo_name);\n        } else {\n            url = \"/search\";\n        }\n        if (newTab === true) {\n            window.open(url);\n        } else {\n            window.location.href = url;\n        }\n    }\n\n    function showHelp() {\n        helpScreen\n            .removeClass(\"hidden\")\n            .children()\n            .on(\"click\", function (event) {\n                // Prevent clicks inside the element to reach the document\n                event.stopImmediatePropagation();\n                return true;\n            });\n\n        jQuery(document).on(\"click\", hideHelp);\n    }\n\n    function hideHelp() {\n        helpScreen.addClass(\"hidden\").children().off(\"click\");\n        jQuery(document).off(\"click\", hideHelp);\n        return true;\n    }\n\n    function handleHashChange(scrollElementIntoView) {\n        if (scrollElementIntoView === undefined) {\n            scrollElementIntoView = true; // default if nothing was provided\n        }\n\n        // Clear current highlights\n        lineNumberContainer.find(\".highlighted\").removeClass(\"highlighted\");\n\n        // Highlight the current range from the hash, if any\n        var range = parseHashForLineRange(document.location.hash);\n        if (range) {\n            addHighlightClassesForRange(range, lineNumberContainer);\n            if (scrollElementIntoView) {\n                scrollToRange(range, root);\n            }\n        }\n\n        // Update the external-browse link\n        jQuery(\"#external-link\").attr(\"href\", getExternalLink(range));\n    }\n\n    function getLineNumber(range) {\n        if (range == null) {\n            // Default to first line if no lines are selected.\n            return 1;\n        } else if (range.start == range.end) {\n            return range.start;\n        } else {\n            // We blindly assume that the external viewer supports linking to a\n            // range of lines. Github doesn't support this, but highlights the\n            // first line given, which is close enough.\n            return range.start + \"-\" + range.end;\n        }\n    }\n\n    function getExternalLink(range) {\n        var lno = getLineNumber(range);\n\n        var repoName = initData.repo_name;\n        var filePath = initData.file_path;\n        let url = initData.url_pattern;\n\n        // If url not found, warn user and fail gracefully\n        if (!url) {\n            // deal with both undefined and empty string\n            console.error(\n                \"The index file you provided does not provide repositories[x].metadata.url_pattern. External links to file sources will not work. See the README for more information on file viewing.\",\n            );\n            return;\n        }\n\n        // If {path} already has a slash in front of it, trim extra leading\n        // slashes from `pathInRepo` to avoid a double-slash in the URL.\n        if (url.indexOf(\"/{path}\") !== -1) {\n            filePath = filePath.replace(/^\\/+/, \"\");\n        }\n\n        // XXX code copied\n        url = url.replace(\"{lno}\", lno);\n        url = url.replace(\"{version}\", initData.commit);\n        url = url.replace(\"{name}\", repoName);\n        url = url.replace(\"{path}\", filePath);\n        return url;\n    }\n\n    function updateFragments(range, $anchors) {\n        $anchors.each(function () {\n            var $a = jQuery(this);\n            var href = $a.attr(\"href\").split(\"#\")[0];\n            if (range !== null) {\n                href += \"#L\" + getLineNumber(range);\n            }\n            $a.attr(\"href\", href);\n        });\n    }\n\n    function processKeyEvent(event) {\n        if (event.which === KeyCodes.ENTER) {\n            // Perform a new search with the selected text, if any\n            var selectedText = getSelectedText();\n            if (selectedText) {\n                doSearch(event, selectedText, true);\n            }\n        } else if (event.which === KeyCodes.SLASH_OR_QUESTION_MARK) {\n            event.preventDefault();\n            if (event.shiftKey) {\n                showHelp();\n            } else {\n                hideHelp();\n                doSearch(event, getSelectedText());\n            }\n        } else if (event.which === KeyCodes.ESCAPE) {\n            // Avoid swallowing the important escape key event unless we're sure we want to\n            if (!helpScreen.hasClass(\"hidden\")) {\n                event.preventDefault();\n                hideHelp();\n            }\n            jQuery(\"#query\").blur();\n        } else if (String.fromCharCode(event.which) == \"V\") {\n            // Visually highlight the external link to indicate what happened\n            jQuery(\"#external-link\").focus();\n            window.location = jQuery(\"#external-link\").attr(\"href\");\n        } else if (String.fromCharCode(event.which) == \"N\" || String.fromCharCode(event.which) == \"P\") {\n            var goBackwards = String.fromCharCode(event.which) === \"P\";\n            var selectedText = getSelectedText();\n            if (selectedText) {\n                window.find(selectedText, false /* case sensitive */, goBackwards);\n            }\n        }\n        return true;\n    }\n\n    function initializeActionButtons(root) {\n        // Map out action name to function call, and automate the details of actually hooking\n        // up the event handling.\n        var ACTION_MAP = {\n            search: doSearch,\n            help: showHelp,\n        };\n\n        for (var actionName in ACTION_MAP) {\n            root.on(\n                \"click auxclick\",\n                '[data-action-name=\"' + actionName + '\"]',\n                // We can't use the action mapped handler directly here since the iterator (`actioName`)\n                // will keep changing in the closure of the inline function.\n                // Generating a click handler on the fly removes the dependency on closure which\n                // makes this work as one would expect. #justjsthings.\n                (function (handler) {\n                    return function (event) {\n                        event.preventDefault();\n                        event.stopImmediatePropagation(); // Prevent immediately closing modals etc.\n                        handler.call(this, event);\n                    };\n                })(ACTION_MAP[actionName]),\n            );\n        }\n    }\n\n    var showSelectionReminder = function () {\n        jQuery(\".without-selection\").hide();\n        jQuery(\".with-selection\").show();\n    };\n\n    var hideSelectionReminder = function () {\n        jQuery(\".without-selection\").show();\n        jQuery(\".with-selection\").hide();\n    };\n\n    function initializePage() {\n        // Initial range detection for when the page is loaded\n        handleHashChange();\n\n        // Allow shift clicking links to expand the highlight range\n        lineNumberContainer.on(\"click\", \"a\", function (event) {\n            event.preventDefault();\n            if (event.shiftKey) {\n                expandRangeToElement(jQuery(event.target), lineNumberContainer);\n            } else {\n                setHash(jQuery(event.target).attr(\"href\"));\n            }\n            handleHashChange(false);\n        });\n\n        jQuery(window).on(\"hashchange\", function (event) {\n            event.preventDefault();\n            // The url was updated with a new range\n            handleHashChange();\n        });\n\n        jQuery(document).on(\"keydown\", function (event) {\n            // Filter out key events when the user has focused an input field.\n            if (jQuery(event.target).is(\"input,textarea\")) return;\n            // Filter out key if a modifier is pressed.\n            if (event.altKey || event.ctrlKey || event.metaKey) return;\n            processKeyEvent(event);\n        });\n\n        jQuery(document).mouseup(function () {\n            var selectedText = getSelectedText();\n            if (selectedText) {\n                showSelectionReminder(selectedText);\n            } else {\n                hideSelectionReminder();\n            }\n        });\n\n        initializeActionButtons(jQuery(\".header .header-actions\"));\n    }\n\n    // The native browser handling of hashes in the location is to scroll\n    // to the element that has a name matching the id. We want to prevent\n    // this since we want to take control over scrolling ourselves, and the\n    // most reliable way to do this is to hide the elements until the page\n    // has loaded. We also need defer our own scroll handling since we can't\n    // access the geometry of the DOM elements until they are visible.\n    setTimeout(function () {\n        lineNumberContainer.css({display: \"block\"});\n        initializePage();\n    }, 1);\n}\n\njQuery(() => {\n    init(JSON.parse(document.getElementById(\"data\").text));\n});\n"],
  "mappings": "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",
  "names": ["import_jquery", "KeyCodes", "getSelectedText", "scrollToRange", "range", "elementContainer", "viewport", "jQuery", "viewportHeight", "scrollOffset", "firstLineElement", "lastLineElement", "rangeHeight", "setHash", "hash", "parseHashForLineRange", "hashString", "parseMatch", "startLine", "endLine", "addHighlightClassesForRange", "root", "idSelectors", "lineNumber", "expandRangeToElement", "element", "elementLine", "init", "initData", "lineNumberContainer", "helpScreen", "doSearch", "event", "query", "newTab", "url", "showHelp", "hideHelp", "handleHashChange", "scrollElementIntoView", "getExternalLink", "getLineNumber", "lno", "repoName", "filePath", "updateFragments", "$anchors", "$a", "href", "processKeyEvent", "selectedText", "goBackwards", "initializeActionButtons", "ACTION_MAP", "actionName", "handler", "showSelectionReminder", "hideSelectionReminder", "initializePage"]
}
