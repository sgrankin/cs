{
  "version": 3,
  "sources": ["../web/fileview.ts"],
  "sourcesContent": ["/**\n * Copyright 2011-2013 Nelson Elhage\n * SPDX-License-Identifier: BSD-2-Clause\n */\n\nimport jQuery from \"jquery\";\nimport \"./codesearch.css\";\nimport \"./fileview.css\";\nimport * as api from \"./api.ts\";\n\nfunction getSelectedText() {\n    return window.getSelection()?.toString() || \"\";\n}\n\nfunction scrollToRange(range: { start: number; end: number; }, elementContainer: JQuery) {\n    // - If we have a single line, scroll the viewport so that the element is\n    // at 1/3 of the viewport.\n    // - If we have a range, try and center the range in the viewport\n    // - If the range is to high to fit in the viewport, fallback to the single\n    //   element scenario for the first line\n    let viewport = jQuery(window);\n    let viewportHeight = viewport.height() || 0;\n\n    let scrollOffset = Math.floor(viewportHeight / 3.0);\n\n    let firstLineElement = elementContainer.find(\"#L\" + range.start);\n    if (!firstLineElement.length) {\n        // We were given a scroll offset to a line number that doesn't exist in the page, bail\n        return;\n    }\n    if (range.start != range.end) {\n        // We have a range, try and center the entire range.\n        // If it's too high for the viewport, fallback to revealing the first element.\n        let lastLineElement = elementContainer.find(\"#L\" + range.end);\n        let rangeHeight =\n            lastLineElement.offset().top + lastLineElement.height() - firstLineElement.offset().top;\n        if (rangeHeight <= viewportHeight) {\n            // Range fits in viewport, center it\n            scrollOffset = 0.5 * (viewportHeight - rangeHeight);\n        } else {\n            scrollOffset = firstLineElement.height() / 2; // Stick to (almost) the top of the viewport\n        }\n    }\n\n    viewport.scrollTop(firstLineElement.offset().top - scrollOffset);\n}\n\nfunction setHash(hash: string) {\n    if (history.replaceState) {\n        history.replaceState(null, \"\", hash);\n    } else {\n        location.hash = hash;\n    }\n}\n\nfunction parseHashForLineRange(hashString: string) {\n    let parseMatch = hashString.match(/#L(\\d+)(?:-L?(\\d+))?/);\n\n    if (parseMatch && parseMatch.length === 3) {\n        // We have a match on the regex expression\n        let startLine = parseInt(parseMatch[1], 10);\n        let endLine = parseInt(parseMatch[2], 10);\n        if (isNaN(endLine) || endLine < startLine) {\n            endLine = startLine;\n        }\n        return {\n            start: startLine,\n            end: endLine,\n        };\n    }\n\n    return null;\n}\n\nfunction addHighlightClassesForRange(range: { start: number; end: number; }, root: JQuery) {\n    let idSelectors: string[] = [];\n    for (let lineNumber = range.start; lineNumber <= range.end; lineNumber++) {\n        idSelectors.push(\"#L\" + lineNumber);\n    }\n    root.find(idSelectors.join(\",\")).addClass(\"highlighted\");\n}\n\nfunction expandRangeToElement(element: JQuery) {\n    let range = parseHashForLineRange(document.location.hash);\n    if (range) {\n        let elementLine = parseInt(element.attr(\"id\").replace(\"L\", \"\"), 10);\n        if (elementLine < range.start) {\n            range.end = range.start;\n            range.start = elementLine;\n        } else {\n            range.end = elementLine;\n        }\n        setHash(\"#L\" + range.start + \"-\" + range.end);\n    }\n}\n\nfunction init(initData: FileViewData) {\n    let root = jQuery(\".file-content\");\n    let lineNumberContainer = root.find(\".line-numbers\");\n    let helpScreen = jQuery(\".help-screen\");\n\n    function doSearch(query: string, newTab = false) {\n        let url = \"/search\" + (query\n            ? \"?q=\" + encodeURIComponent(query) + \"&repo=\" + encodeURIComponent(initData.repo_name)\n            : \"\");\n\n        if (newTab)\n            window.open(url);\n        else\n            window.location.href = url;\n\n    }\n\n    function showHelp() {\n        helpScreen\n            .removeClass(\"hidden\")\n            .children()\n            .on(\"click\", function (event) {\n                // Prevent clicks inside the element to reach the document\n                event.stopImmediatePropagation();\n                return true;\n            });\n\n        jQuery(document).on(\"click\", hideHelp);\n    }\n\n    function hideHelp() {\n        helpScreen.addClass(\"hidden\").children().off(\"click\");\n        jQuery(document).off(\"click\", hideHelp);\n        return true;\n    }\n\n    function handleHashChange(scrollElementIntoView = true) {\n        // Clear current highlights\n        lineNumberContainer.find(\".highlighted\").removeClass(\"highlighted\");\n\n        // Highlight the current range from the hash, if any\n        let range = parseHashForLineRange(document.location.hash);\n        if (range) {\n            addHighlightClassesForRange(range, lineNumberContainer);\n            if (scrollElementIntoView) {\n                scrollToRange(range, root);\n            }\n        }\n\n        // Update the external-browse link\n        jQuery(\"#external-link\").attr(\"href\", getExternalLink(range));\n    }\n\n    function getLineNumber(range: { start: number; end: number; } | null) {\n        if (range == null) {\n            // Default to first line if no lines are selected.\n            return \"1\";\n        } else if (range.start == range.end) {\n            return range.start;\n        } else {\n            // We blindly assume that the external viewer supports linking to a\n            // range of lines. Github doesn't support this, but highlights the\n            // first line given, which is close enough.\n            return range.start + \"-\" + range.end;\n        }\n    }\n\n    function getExternalLink(range: { start: number; end: number; } | null) {\n        let lno = getLineNumber(range);\n\n        let repoName = initData.repo_name;\n        let filePath = initData.file_path;\n        let url = initData.url_pattern;\n\n        // If url not found, warn user and fail gracefully\n        if (!url) {\n            // deal with both undefined and empty string\n            console.error(\n                \"The index file you provided does not provide repositories[x].metadata.url_pattern. External links to file sources will not work. See the README for more information on file viewing.\",\n            );\n            return;\n        }\n\n        // If {path} already has a slash in front of it, trim extra leading\n        // slashes from `pathInRepo` to avoid a double-slash in the URL.\n        if (url.indexOf(\"/{path}\") !== -1) {\n            filePath = filePath.replace(/^\\/+/, \"\");\n        }\n\n        // XXX code copied\n        url = url.replace(\"{lno}\", lno.toString());\n        url = url.replace(\"{version}\", initData.commit);\n        url = url.replace(\"{name}\", repoName);\n        url = url.replace(\"{path}\", filePath);\n        return url;\n    }\n\n    function processKeyEvent(key: string) {\n        switch (key) {\n            case \"Enter\": {\n                // Perform a new search with the selected text, if any\n                let selectedText = getSelectedText();\n                if (selectedText) {\n                    doSearch(selectedText, true);\n                }\n                return true;\n            }\n            case \"/\": {\n                hideHelp();\n                doSearch(getSelectedText());\n                return true;\n            }\n            case \"?\": {\n                showHelp();\n                return true;\n            }\n            case \"Escape\": {\n                // Avoid swallowing the important escape key event unless we're sure we want to\n                if (helpScreen.hasClass(\"hidden\")) {\n                    return false;\n                }\n                hideHelp();\n                jQuery(\"#query\").trigger(\"blur\");\n                return true;\n            }\n            case \"v\": {\n                // Visually highlight the external link to indicate what happened\n                let link = jQuery(\"#external-link\");\n                link.trigger(\"focus\");\n                window.location.href = link.attr(\"href\") as string;\n                return true;\n            }\n            case \"n\":\n            case \"p\": {\n                let selectedText = getSelectedText();\n                if (selectedText) {\n                    window.find(selectedText, /*case-sensitive:*/false, /*previous:*/key == \"p\");\n                }\n                return true;\n            }\n        }\n        return false;\n    }\n\n    function initializeActionButtons(root: JQuery) {\n        // Map out action name to function call, and automate the details of actually hooking up the event handling.\n        let ACTION_MAP = {\n            search: doSearch,\n            help: showHelp,\n        };\n\n        for (let actionName in ACTION_MAP) {\n            root.on(\n                \"click auxclick\",\n                '[data-action-name=\"' + actionName + '\"]',\n                // We can't use the action mapped handler directly here since the iterator (`actioName`)\n                // will keep changing in the closure of the inline function.\n                // Generating a click handler on the fly removes the dependency on closure which\n                // makes this work as one would expect. #justjsthings.\n                (function (handler) {\n                    return function (event) {\n                        event.preventDefault();\n                        event.stopImmediatePropagation(); // Prevent immediately closing modals etc.\n                        handler();\n                    };\n                })(ACTION_MAP[actionName]),\n            );\n        }\n    }\n\n    let showSelectionReminder = function () {\n        jQuery(\".without-selection\").hide();\n        jQuery(\".with-selection\").show();\n    };\n\n    let hideSelectionReminder = function () {\n        jQuery(\".without-selection\").show();\n        jQuery(\".with-selection\").hide();\n    };\n\n    function initializePage() {\n        // Initial range detection for when the page is loaded\n        handleHashChange();\n\n        // Allow shift clicking links to expand the highlight range\n        lineNumberContainer.on(\"click\", \"a\", function (event) {\n            event.preventDefault();\n            if (event.shiftKey) {\n                expandRangeToElement(jQuery(event.target));\n            } else {\n                setHash(jQuery(event.target).attr(\"href\"));\n            }\n            handleHashChange(false);\n        });\n\n        jQuery(window).on(\"hashchange\", function (event) {\n            event.preventDefault();\n            // The url was updated with a new range\n            handleHashChange();\n        });\n\n        jQuery(document).on(\"keydown\", event => {\n            // Filter out key events when the user has focused an input field.\n            if (jQuery(event.target).is(\"input,textarea\")) return;\n            // Filter out key if a modifier is pressed.\n            if (event.altKey || event.ctrlKey || event.metaKey) return;\n            if (processKeyEvent(event.key)) event.preventDefault();\n        });\n\n        jQuery(document).on(\"mouseup\", function () {\n            let selectedText = getSelectedText();\n            if (selectedText) {\n                showSelectionReminder();\n            } else {\n                hideSelectionReminder();\n            }\n        });\n\n        initializeActionButtons(jQuery(\".header .header-actions\"));\n    }\n\n    // The native browser handling of hashes in the location is to scroll\n    // to the element that has a name matching the id. We want to prevent\n    // this since we want to take control over scrolling ourselves, and the\n    // most reliable way to do this is to hide the elements until the page\n    // has loaded. We also need defer our own scroll handling since we can't\n    // access the geometry of the DOM elements until they are visible.\n    setTimeout(function () {\n        lineNumberContainer.css({display: \"block\"});\n        initializePage();\n    }, 1);\n}\n\njQuery(() => {\n    init(JSON.parse((document.getElementById(\"data\") as HTMLScriptElement).text) as api.FileViewData);\n});\n"],
  "mappings": "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",
  "names": ["jQuery", "root"]
}
